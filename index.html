<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a6b8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="è»Šã‚³ã‚¹ãƒˆæ¯”è¼ƒ">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
<title>æ–°è»Šãƒ»ä¸­å¤è»Š ã‚³ã‚¹ãƒˆæ¯”è¼ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
:root {
  --new-car-color: #1a6b8a;
  --new-car-dark: #0e4f6a;
  --new-car-light: #ddeef6;
  --used-car-color: #b35c1e;
  --used-car-dark: #8a4510;
  --used-car-light: #f8e8d6;
  --result-positive: #1a7a4a;
  --result-positive-light: #d6f0e2;
  --warn-color: #b83a2a;
  --bg-main: #f5f3ee;
  --bg-warm: #ece8df;
  --bg-card: #ffffff;
  --text-primary: #1a1a1a;
  --text-secondary: #6e6e6e;
  --border-color: #d0cabe;
  --border-light: #e4dfd5;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Zen Kaku Gothic New', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
  background: var(--bg-main);
  color: var(--text-primary);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
}

#app {
  max-width: 980px;
  margin: 0 auto;
  padding: 40px 24px 80px;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
.header {
  display: flex;
  align-items: baseline;
  justify-content: center;
  gap: 12px;
  margin-bottom: 2rem;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--text-primary);
}
.header h1 {
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: 0.04em;
  color: var(--text-primary);
}
.header p {
  font-size: 0.8rem;
  color: var(--text-secondary);
  font-weight: 400;
}

/* ===== èª¬æ˜æ–‡ ===== */
.guide-box {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-left: 4px solid var(--new-car-color);
  border-radius: var(--radius, 6px);
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  font-size: 0.85rem;
  line-height: 1.8;
  color: var(--text-secondary);
  box-shadow: var(--shadow-sm);
}
.guide-box strong {
  color: var(--text-primary);
  font-weight: 600;
}
.section-note {
  font-size: 0.8rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 0.75rem;
}
.kpi-guide {
  text-align: center;
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 0.75rem;
  line-height: 1.6;
}

/* ===== å°åˆ·ãƒœã‚¿ãƒ³ ===== */
.print-btn {
  position: fixed;
  top: 1rem;
  right: 1rem;
  font-family: inherit;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 6px 16px;
  font-size: 0.75rem;
  cursor: pointer;
  color: var(--text-secondary);
  z-index: 100;
  transition: all 0.15s;
}
.print-btn:hover {
  background: var(--bg-warm);
  border-color: var(--text-secondary);
}

/* ===== å°åˆ·ç”¨æ¡ä»¶ã‚µãƒãƒªãƒ¼ï¼ˆç”»é¢ã§ã¯éè¡¨ç¤ºï¼‰ ===== */
.print-conditions {
  display: none;
}

/* ===== è»Šä¸¡æƒ…å ±å…¥åŠ›ã‚¨ãƒªã‚¢ ===== */
.input-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}
.input-column {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 1.25rem;
  box-shadow: var(--shadow-sm);
}
.input-column.new-car {
  border-left: 4px solid var(--new-car-color);
}
.input-column.used-car {
  border-left: 4px solid var(--used-car-color);
}
.input-column h3 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
}
.input-column.new-car h3 { color: var(--new-car-color); }
.input-column.used-car h3 { color: var(--used-car-color); }

.input-group {
  margin-bottom: 1rem;
}
.input-group:last-child {
  margin-bottom: 0;
}
.input-group label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}
.input-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.input-row input[type="range"] {
  flex: 1;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border-color);
  border-radius: 3px;
  outline: none;
}
.input-row input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--new-car-color);
  cursor: pointer;
}
.used-car .input-row input[type="range"]::-webkit-slider-thumb {
  background: var(--used-car-color);
}
.input-row input[type="number"] {
  width: 130px;
  padding: 0.4rem 0.5rem;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-family: inherit;
  font-size: 1rem;
  text-align: right;
  font-variant-numeric: tabular-nums;
}
.input-row .unit {
  font-size: 0.875rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.auto-info {
  display: flex;
  gap: 1.5rem;
  margin-top: 0.75rem;
  padding: 0.75rem;
  background: var(--used-car-light);
  border-radius: 6px;
}
.auto-info-item {
  font-size: 0.875rem;
  color: var(--text-secondary);
}
.auto-info-item span {
  font-weight: 600;
  color: var(--text-primary);
}
.auto-info-item.warning span {
  color: var(--warn-color);
  font-weight: 700;
}

.ownership-section {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-left: 4px solid var(--result-positive);
  border-radius: 6px;
  padding: 1.25rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm);
}
.ownership-section h3 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  color: var(--text-primary);
}

/* ===== KPIã‚«ãƒ¼ãƒ‰ ===== */
.kpi-section {
  margin-bottom: 1.5rem;
}
.kpi-top {
  display: grid;
  grid-template-columns: 1fr 1.2fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}
.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 1.25rem;
  text-align: center;
  box-shadow: var(--shadow-sm);
}
.kpi-card .kpi-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}
.kpi-card .kpi-value {
  font-size: 2.5rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  line-height: 1.2;
}
.kpi-card .kpi-unit {
  font-size: 1rem;
  font-weight: 400;
  color: var(--text-secondary);
}
.kpi-card.new-car {
  border-left: 4px solid var(--new-car-color);
}
.kpi-card.new-car .kpi-value { color: var(--new-car-color); }
.kpi-card.used-car {
  border-left: 4px solid var(--used-car-color);
}
.kpi-card.used-car .kpi-value { color: var(--used-car-color); }
.kpi-card.difference {
  border-left: 4px solid var(--result-positive);
  background: var(--result-positive-light);
}
.kpi-card.difference .kpi-value {
  font-size: 2rem;
  font-weight: 700;
}
.kpi-card.difference .kpi-verdict {
  font-size: 1rem;
  font-weight: 600;
  margin-top: 0.25rem;
}

.kpi-bottom {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.kpi-summary {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 1rem;
  text-align: center;
  font-size: 1rem;
  color: var(--text-secondary);
  box-shadow: var(--shadow-sm);
}
.kpi-summary .summary-total {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1.1rem;
}

/* ===== ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ ===== */
.charts-section {
  margin-bottom: 1.5rem;
}
.chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 1.25rem;
  box-shadow: var(--shadow-sm);
}
.chart-card h3 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  text-align: center;
  color: var(--text-primary);
}
.chart-card canvas {
  width: 100% !important;
  max-height: 350px;
}

/* ===== ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
.table-section {
  margin-bottom: 1.5rem;
}
.table-section h3 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
}
.cost-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--bg-card);
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid var(--border-color);
  font-variant-numeric: tabular-nums;
  box-shadow: var(--shadow-sm);
}
.cost-table th, .cost-table td {
  padding: 0.6rem 1rem;
  text-align: right;
  border-bottom: 1px solid var(--border-color);
  font-size: 1rem;
}
.cost-table th {
  background: var(--bg-warm);
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--text-secondary);
}
.cost-table th:first-child, .cost-table td:first-child {
  text-align: left;
}
.cost-table td:last-child {
  text-align: left;
  font-size: 0.875rem;
  color: var(--text-secondary);
}
.cost-table tr.total-row td {
  font-weight: 700;
  font-size: 1.05rem;
  border-top: 2px solid var(--border-color);
}
.cost-table tr.annual-row td {
  font-weight: 700;
  font-size: 1.1rem;
  background: var(--bg-warm);
}
.cost-table tr.annual-row td.highlight-new {
  background: var(--new-car-light);
  color: var(--new-car-color);
}
.cost-table tr.annual-row td.highlight-used {
  background: var(--used-car-light);
  color: var(--used-car-color);
}
.cost-table th.col-new { color: var(--new-car-color); }
.cost-table th.col-used { color: var(--used-car-color); }

/* ===== æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
.settings-section {
  margin-bottom: 1.5rem;
}
.settings-toggle {
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 0.85rem 1.25rem;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: background 0.2s;
  box-shadow: var(--shadow-sm);
}
.settings-toggle:hover {
  background: var(--bg-warm);
}
.settings-toggle .arrow {
  transition: transform 0.3s;
  font-size: 0.75rem;
}
.settings-toggle.open .arrow {
  transform: rotate(180deg);
}
.settings-content {
  display: none;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-top: none;
  border-radius: 0 0 6px 6px;
  padding: 1.25rem;
}
.settings-content.open {
  display: block;
}
.settings-toggle.open {
  border-radius: 6px 6px 0 0;
}

/* ----- ç¶­æŒè²»ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ ----- */
.settings-table {
  width: 100%;
  border-collapse: collapse;
}
.settings-table th,
.settings-table td {
  padding: 0.5rem 0.5rem;
  vertical-align: middle;
  border-bottom: 1px solid var(--border-color);
}
.settings-table thead th {
  font-size: 0.8rem;
  font-weight: 600;
  text-align: center;
  color: var(--text-secondary);
  padding-bottom: 0.6rem;
  border-bottom: 2px solid var(--border-color);
}
.settings-table thead th:first-child {
  text-align: left;
}
.settings-table thead th.col-new { color: var(--new-car-color); }
.settings-table thead th.col-used { color: var(--used-car-color); }
.settings-table tbody td:first-child {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text-secondary);
  white-space: nowrap;
  padding-right: 1rem;
}
.settings-table .st-input {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.settings-table input[type="range"] {
  width: 100px;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border-color);
  border-radius: 2px;
  outline: none;
  flex-shrink: 0;
}
.settings-table input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--text-secondary);
  cursor: pointer;
}
.settings-table td.col-new input[type="range"]::-webkit-slider-thumb {
  background: var(--new-car-color);
}
.settings-table td.col-used input[type="range"]::-webkit-slider-thumb {
  background: var(--used-car-color);
}
.settings-table input[type="number"] {
  width: 90px;
  padding: 0.3rem 0.4rem;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 0.9rem;
  text-align: right;
  font-variant-numeric: tabular-nums;
}
.settings-table .st-unit {
  font-size: 0.75rem;
  color: var(--text-secondary);
  white-space: nowrap;
}
.settings-table tr:last-child td {
  border-bottom: none;
}
.settings-note {
  margin-top: 0.6rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* ===== ãƒ•ãƒƒã‚¿ãƒ¼ ===== */
.footer {
  text-align: center;
  color: var(--text-secondary);
  font-size: 0.8rem;
  padding: 1.5rem 0 1rem;
  margin-top: 1rem;
  border-top: 2px solid var(--text-primary);
  line-height: 1.8;
}

/* ===== è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
.warning-message {
  display: none;
  background: #fdf0ef;
  border: 1px solid #e8c8c4;
  border-left: 4px solid var(--warn-color);
  border-radius: 6px;
  padding: 0.75rem 1rem;
  color: var(--warn-color);
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 1rem;
  text-align: center;
}
.warning-message.show {
  display: block;
}

/* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
@media (max-width: 768px) {
  .input-section { grid-template-columns: 1fr; }
  .kpi-top { grid-template-columns: 1fr; }
  .kpi-bottom { grid-template-columns: 1fr; }
  .charts-section { grid-template-columns: 1fr; }
  .kpi-card .kpi-value { font-size: 2rem; }
  .kpi-card.difference .kpi-value { font-size: 1.75rem; }
  .cost-table { font-size: 0.875rem; }
  .cost-table th, .cost-table td { padding: 0.5rem 0.5rem; }
  .header h1 { font-size: 1.35rem; }
  .settings-table input[type="range"] { width: 60px; }
  .settings-table input[type="number"] { width: 75px; }
}

/* ============================================================
   å°åˆ·ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â€” A4æ¨ªå‘ã1æšã«åã‚ã‚‹
   ============================================================ */
@media print {
  @page {
    size: A4 landscape;
    margin: 8mm 10mm;
  }

  html, body {
    margin: 0;
    padding: 0;
    background: #fff;
    font-size: 10px;
    line-height: 1.35;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* ç”»é¢å°‚ç”¨UIã‚’éè¡¨ç¤º */
  .print-btn,
  .input-section,
  .ownership-section,
  .warning-message,
  .settings-section {
    display: none !important;
  }

  /* èª¬æ˜æ–‡ã‚’å°åˆ·ç”¨ã«èª¿æ•´ */
  .guide-box {
    padding: 0.4em 0.8em;
    margin-bottom: 0.5em;
    font-size: 0.85em;
    line-height: 1.5;
    border-color: var(--border-color);
    border-left-color: var(--new-car-color);
    background: var(--bg-card);
  }
  .section-note {
    font-size: 0.7em;
    margin-bottom: 0.3em;
  }
  .kpi-guide {
    font-size: 0.8em;
    margin-bottom: 0.3em;
  }

  /* å°åˆ·ç”¨æ¡ä»¶ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º */
  .print-conditions {
    display: flex !important;
    gap: 1.5em;
    justify-content: center;
    flex-wrap: wrap;
    padding: 0.4em 0;
    margin-bottom: 0.5em;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-card);
    font-size: 1.05em;
    color: var(--text-primary);
  }
  .print-conditions .pc-item {
    white-space: nowrap;
  }
  .print-conditions .pc-label {
    color: var(--text-secondary);
    margin-right: 0.3em;
  }
  .print-conditions .pc-value {
    font-weight: 600;
  }
  .print-conditions .pc-value.new-car { color: var(--new-car-color); }
  .print-conditions .pc-value.used-car { color: var(--used-car-color); }

  /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ */
  #app {
    max-width: 100%;
    padding: 0;
    margin: 0;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    margin-bottom: 0.3em;
  }
  .header h1 {
    font-size: 1.6em;
    margin-bottom: 0;
  }
  .header p {
    font-size: 0.95em;
    margin-top: 0;
  }

  /* KPIã‚«ãƒ¼ãƒ‰ */
  .kpi-section {
    margin-bottom: 0.5em;
  }
  .kpi-top {
    display: grid;
    grid-template-columns: 1fr 1.3fr 1fr;
    gap: 0.5em;
    margin-bottom: 0.4em;
  }
  .kpi-card {
    padding: 0.4em 0.5em;
    border-radius: 6px;
  }
  .kpi-card .kpi-label {
    font-size: 0.9em;
    margin-bottom: 0;
  }
  .kpi-card .kpi-value {
    font-size: 2.2em;
    line-height: 1.15;
  }
  .kpi-card .kpi-unit {
    font-size: 0.8em;
  }
  .kpi-card.difference .kpi-value {
    font-size: 1.8em;
  }
  .kpi-card.difference .kpi-verdict {
    font-size: 0.95em;
    margin-top: 0;
  }
  .kpi-bottom {
    gap: 0.5em;
  }
  .kpi-summary {
    padding: 0.3em 0.5em;
    font-size: 0.95em;
    border-radius: 6px;
  }
  .kpi-summary .summary-total {
    font-size: 1em;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: ãƒ†ãƒ¼ãƒ–ãƒ«å·¦ + ã‚°ãƒ©ãƒ•å³ */
  .main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas: "table charts";
    gap: 0.6em;
    align-items: start;
  }
  .table-section {
    grid-area: table;
    margin-bottom: 0;
  }
  .charts-section {
    grid-area: charts;
    display: flex;
    flex-direction: column;
    gap: 0.5em;
    margin-bottom: 0;
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-section h3 {
    font-size: 1.05em;
    margin-bottom: 0.2em;
  }
  .cost-table {
    border-radius: 4px;
  }
  .cost-table th, .cost-table td {
    padding: 0.2em 0.5em;
    font-size: 0.95em;
  }
  .cost-table th {
    font-size: 0.85em;
  }
  .cost-table td:last-child {
    font-size: 0.75em;
  }
  .cost-table tr.total-row td {
    font-size: 0.95em;
  }
  .cost-table tr.annual-row td {
    font-size: 1em;
  }

  /* ã‚°ãƒ©ãƒ• */
  .chart-card {
    padding: 0.4em;
    border-radius: 6px;
    break-inside: avoid;
  }
  .chart-card h3 {
    font-size: 0.95em;
    margin-bottom: 0.2em;
  }
  .chart-card canvas {
    max-height: none;
  }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer {
    font-size: 0.75em;
    padding: 0.3em 0 0;
    margin-top: 0.3em;
    line-height: 1.5;
    border-top: 1px solid var(--border-color);
  }

  /* æ”¹ãƒšãƒ¼ã‚¸é˜²æ­¢ */
  .kpi-section, .main-content, .footer {
    break-inside: avoid;
  }
}
</style>
</head>
<body>

<button class="print-btn" onclick="window.print()">ğŸ–¨ å°åˆ·</button>

<div id="app">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <h1>æ–°è»Šãƒ»ä¸­å¤è»Š ã‚³ã‚¹ãƒˆæ¯”è¼ƒ</h1>
    <p>è³¼å…¥é‡‘é¡ï¼‹ç¶­æŒè²»ã®å¹´é–“ã‚³ã‚¹ãƒˆã§æ¯”è¼ƒã—ã¾ã™</p>
  </div>

  <!-- å…¨ä½“èª¬æ˜ -->
  <div class="guide-box">
    ä¸­å¤è»Šã®ã€Œâ—‹å¹´è½ã¡ã€ã¯ã€<strong>è»Šã«ä¹—ã‚Œã‚‹å¹´æ•°ãŒã™ã§ã«ãã®åˆ†ã ã‘å¤±ã‚ã‚Œã¦ã„ã‚‹</strong>ã¨ã»ã¼åŒç¾©ã¨ãªã‚Šã¾ã™ã€‚<br>
    çµæœçš„ã«æ–°è»Šã‹ã‚‰13å¹´ä¹—ã‚ŒãŸè»Šã¨ã™ã‚‹ã¨ã€æ–°è»Šã¯13å¹´é–“ä¹—ã‚Œã¾ã™ãŒã€5å¹´è½ã¡ã®ä¸­å¤è»Šã¯æ®‹ã‚Š8å¹´ã§æ–°è»ŠçµŒéå¹´æ•°13å¹´ã‚’è¿ãˆã¾ã™ã€‚<br><br>
    <strong>è³¼å…¥é‡‘é¡ã¯ä¸­å¤è»ŠãŒå®‰ã„ã§ã™ãŒã€ä¹—ã‚Œã‚‹å¹´æ•°ã‚‚çŸ­ããªã‚‹ãŸã‚ã€ãã®å¹´æ•°ã¯å·®ã—å¼•ã„ã¦ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹</strong>ã®ãŒåˆç†æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
    ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€è³¼å…¥é‡‘é¡ã¨ç¶­æŒè²»ã®åˆè¨ˆã‚’æ‰€æœ‰å¹´æ•°ã§å‰²ã£ãŸ<strong>ã€Œå¹´é–“ã‚³ã‚¹ãƒˆã€</strong>ã§æ–°è»Šã¨ä¸­å¤è»Šã‚’æ¯”è¼ƒã—ã¾ã™ã€‚
  </div>

  <!-- å°åˆ·ç”¨æ¡ä»¶ã‚µãƒãƒªãƒ¼ï¼ˆç”»é¢ã§ã¯éè¡¨ç¤ºï¼‰ -->
  <div class="print-conditions" id="printConditions">
    <div class="pc-item"><span class="pc-label">æ–°è»Š:</span><span class="pc-value new-car" id="pcNewPrice">4,600,000å††</span></div>
    <div class="pc-item"><span class="pc-label">ä¸­å¤è»Š:</span><span class="pc-value used-car" id="pcUsedPrice">3,500,000å††</span><span class="pc-label">ï¼ˆ</span><span class="pc-value used-car" id="pcUsedYear">2020å¹´ï¼ä»¤å’Œ2å¹´</span><span class="pc-label">å¼ãƒ»çµŒé</span><span class="pc-value" id="pcAge">6</span><span class="pc-label">å¹´ï¼‰</span></div>
    <div class="pc-item"><span class="pc-label">ç·æ‰€æœ‰æœŸé–“:</span><span class="pc-value" id="pcOwnership">15</span><span class="pc-label">å¹´</span></div>
    <div class="pc-item"><span class="pc-label">ä¸­å¤è»Šæ®‹ã‚Š:</span><span class="pc-value" id="pcRemaining">9</span><span class="pc-label">å¹´</span></div>
  </div>

  <!-- è»Šä¸¡æƒ…å ±å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—1ï¼‰ -->
  <div class="input-section">
    <div class="input-column new-car">
      <h3>æ–°è»Š</h3>
      <div class="input-group">
        <label>è³¼å…¥é‡‘é¡</label>
        <div class="input-row">
          <input type="range" id="newCarPriceRange" min="500000" max="10000000" step="10000" value="4600000">
          <input type="number" id="newCarPrice" min="500000" max="10000000" step="10000" value="4600000">
          <span class="unit">å††</span>
        </div>
      </div>
    </div>
    <div class="input-column used-car">
      <h3>ä¸­å¤è»Š</h3>
      <div class="input-group">
        <label>è³¼å…¥é‡‘é¡</label>
        <div class="input-row">
          <input type="range" id="usedCarPriceRange" min="500000" max="10000000" step="10000" value="3000000">
          <input type="number" id="usedCarPrice" min="500000" max="10000000" step="10000" value="3000000">
          <span class="unit">å††</span>
        </div>
      </div>
      <div class="input-group">
        <label>å¹´å¼ï¼ˆè¥¿æš¦ï¼‰</label>
        <div class="input-row">
          <input type="range" id="usedCarYearRange" min="2005" max="2026" step="1" value="2021">
          <input type="number" id="usedCarYear" min="2005" max="2026" step="1" value="2021">
          <span class="unit">å¹´ <span id="warekiDisplay" style="color:var(--used-car-color);font-weight:600;">ï¼ˆä»¤å’Œ2å¹´ï¼‰</span></span>
        </div>
      </div>
      <div class="auto-info" id="autoInfo">
        <div class="auto-info-item">çµŒéå¹´æ•°: <span id="usedCarAge">6</span>å¹´</div>
        <div class="auto-info-item" id="remainingInfo">æ®‹ã‚Šæ‰€æœ‰å¹´æ•°: <span id="usedCarOwnership">9</span>å¹´</div>
      </div>
    </div>
  </div>

  <!-- ç·æ‰€æœ‰æœŸé–“ -->
  <div class="ownership-section">
    <h3>ç·æ‰€æœ‰æœŸé–“</h3>
    <p class="section-note">æ–°è»Šã‚’è³¼å…¥ã—ãŸå ´åˆã«ä½•å¹´ä¹—ã‚‹ã‹ã®æƒ³å®šã§ã™ã€‚ä¸­å¤è»Šã®æ®‹ã‚Šæ‰€æœ‰å¹´æ•°ã¯ã“ã“ã‹ã‚‰çµŒéå¹´æ•°ã‚’å¼•ã„ã¦è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>
    <div class="input-group">
      <div class="input-row">
        <input type="range" id="totalOwnershipRange" min="5" max="20" step="1" value="13">
        <input type="number" id="totalOwnership" min="5" max="20" step="1" value="13">
        <span class="unit">å¹´</span>
      </div>
    </div>
  </div>

  <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div class="warning-message" id="warningMessage">
    ã“ã®ä¸­å¤è»Šã¯æƒ³å®šæ‰€æœ‰æœŸé–“ã‚’æ—¢ã«è¶…ãˆã¦ã„ã¾ã™
  </div>

  <!-- KPIã‚«ãƒ¼ãƒ‰ -->
  <div class="kpi-section">
    <p class="kpi-guide">
      ã€Œè³¼å…¥é‡‘é¡ï¼‹ç¶­æŒè²»ã®ç·é¡ã€Ã·ã€Œæ‰€æœ‰å¹´æ•°ã€ï¼ <strong>1å¹´ã‚ãŸã‚Šã®ã‚³ã‚¹ãƒˆ</strong>ï¼ˆã“ã®é‡‘é¡ãŒå°ã•ã„æ–¹ãŒãŠå¾—ã§ã™ï¼‰
    </p>
    <div class="kpi-top">
      <div class="kpi-card new-car">
        <div class="kpi-label">æ–°è»Š å¹´é–“ã‚³ã‚¹ãƒˆ</div>
        <div class="kpi-value" id="kpiNewAnnual">453,000<span class="kpi-unit">å††/å¹´</span></div>
      </div>
      <div class="kpi-card difference" id="kpiDiffCard">
        <div class="kpi-label">å¹´é–“å·®é¡</div>
        <div class="kpi-value" id="kpiDiffValue">66,333<span class="kpi-unit">å††/å¹´</span></div>
        <div class="kpi-verdict" id="kpiVerdict">æ–°è»ŠãŒå¹´é–“ã‚³ã‚¹ãƒˆãŒå®‰ã„</div>
      </div>
      <div class="kpi-card used-car">
        <div class="kpi-label">ä¸­å¤è»Š å¹´é–“ã‚³ã‚¹ãƒˆ</div>
        <div class="kpi-value" id="kpiUsedAnnual">519,333<span class="kpi-unit">å††/å¹´</span></div>
      </div>
    </div>
    <div class="kpi-bottom">
      <div class="kpi-summary">
        <span class="summary-total" id="summaryNew">ç·é¡ 6,795,000å††</span> Ã· <span id="summaryNewYears">15</span>å¹´
      </div>
      <div class="kpi-summary">
        <span class="summary-total" id="summaryUsed">ç·é¡ 4,674,000å††</span> Ã· <span id="summaryUsedYears">9</span>å¹´
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆå°åˆ·æ™‚ã«2ã‚«ãƒ©ãƒ åŒ–ï¼‰ -->
  <div class="main-content">
    <!-- ç¶­æŒè²»å†…è¨³ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-section">
      <h3>ç¶­æŒè²»å†…è¨³</h3>
      <p class="section-note">æ‰€æœ‰æœŸé–“ä¸­ã«ã‹ã‹ã‚‹è²»ç”¨ã®å†…è¨³ã§ã™ã€‚ç¶­æŒè²»ç·é¡ã«è³¼å…¥é‡‘é¡ã‚’å«ã‚ãŸåˆè¨ˆã‚’æ‰€æœ‰å¹´æ•°ã§å‰²ã£ãŸã‚‚ã®ãŒå¹´é–“ã‚³ã‚¹ãƒˆã§ã™ã€‚</p>
      <table class="cost-table">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th class="col-new">æ–°è»Š</th>
            <th class="col-used">ä¸­å¤è»Š</th>
            <th>èª¬æ˜</th>
          </tr>
        </thead>
        <tbody id="costTableBody">
        </tbody>
      </table>
    </div>

    <!-- ã‚°ãƒ©ãƒ• -->
    <div class="charts-section">
      <div class="chart-card">
        <h3>å¹´é–“ã‚³ã‚¹ãƒˆæ¯”è¼ƒï¼ˆå†…è¨³ä»˜ãï¼‰</h3>
        <p class="section-note" style="text-align:center;">1å¹´ã‚ãŸã‚Šã«æ›ç®—ã—ãŸå„è²»ç”¨é …ç›®ã‚’ç©ã¿ä¸Šã’ã¦æ¯”è¼ƒã—ã¾ã™</p>
        <canvas id="annualChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ç¶­æŒè²»å˜ä¾¡èª¿æ•´ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—2ã€æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="settings-section">
    <button class="settings-toggle" id="settingsToggle" onclick="toggleSettings()">
      ç¶­æŒè²»ã®å˜ä¾¡ã‚’èª¿æ•´ã™ã‚‹ï¼ˆæ–°è»Šãƒ»ä¸­å¤è»Š å€‹åˆ¥è¨­å®šï¼‰
      <span class="arrow">&#9660;</span>
    </button>
    <div class="settings-content" id="settingsContent">
      <table class="settings-table">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th class="col-new">æ–°è»Š</th>
            <th class="col-used">ä¸­å¤è»Š</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>è»Šæ¤œæ•´å‚™è²»ç”¨ï¼ˆå††/å›ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="shakenCostNewRange" min="0" max="200000" step="5000" value="50000">
              <input type="number" id="shakenCostNew" min="0" max="200000" step="5000" value="50000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="shakenCostUsedRange" min="0" max="200000" step="5000" value="50000">
              <input type="number" id="shakenCostUsed" min="0" max="200000" step="5000" value="50000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
          <tr>
            <td>è»Šæ¤œæ³•å®šè²»ç”¨ï¼ˆå††/å›ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="shakenLegalCostNewRange" min="0" max="150000" step="5000" value="40000">
              <input type="number" id="shakenLegalCostNew" min="0" max="150000" step="5000" value="40000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="shakenLegalCostUsedRange" min="0" max="150000" step="5000" value="40000">
              <input type="number" id="shakenLegalCostUsed" min="0" max="150000" step="5000" value="40000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
          <tr>
            <td>å®šæœŸç‚¹æ¤œè²»ç”¨ï¼ˆå††/å›ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="inspectionCostNewRange" min="0" max="100000" step="5000" value="25000">
              <input type="number" id="inspectionCostNew" min="0" max="100000" step="5000" value="25000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="inspectionCostUsedRange" min="0" max="100000" step="5000" value="25000">
              <input type="number" id="inspectionCostUsed" min="0" max="100000" step="5000" value="25000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
          <tr>
            <td>ã‚¿ã‚¤ãƒ¤äº¤æ›è²»ç”¨ï¼ˆå††/å›ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="tireCostNewRange" min="0" max="500000" step="10000" value="100000">
              <input type="number" id="tireCostNew" min="0" max="500000" step="10000" value="100000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="tireCostUsedRange" min="0" max="500000" step="10000" value="100000">
              <input type="number" id="tireCostUsed" min="0" max="500000" step="10000" value="100000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
          <tr>
            <td>ãƒãƒƒãƒ†ãƒªãƒ¼äº¤æ›è²»ç”¨ï¼ˆå††/å›ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="batteryCostNewRange" min="0" max="200000" step="5000" value="25000">
              <input type="number" id="batteryCostNew" min="0" max="200000" step="5000" value="25000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="batteryCostUsedRange" min="0" max="200000" step="5000" value="25000">
              <input type="number" id="batteryCostUsed" min="0" max="200000" step="5000" value="25000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
          <tr>
            <td>ä¸€èˆ¬æ•´å‚™è²»ç”¨ï¼ˆå††/å¹´ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="annualRepairCostNewRange" min="0" max="200000" step="5000" value="30000">
              <input type="number" id="annualRepairCostNew" min="0" max="200000" step="5000" value="30000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="annualRepairCostUsedRange" min="0" max="200000" step="5000" value="30000">
              <input type="number" id="annualRepairCostUsed" min="0" max="200000" step="5000" value="30000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
          <tr>
            <td>è‡ªå‹•è»Šç¨ï¼ˆå††/å¹´ï¼‰</td>
            <td class="col-new"><div class="st-input">
              <input type="range" id="annualTaxNewRange" min="0" max="150000" step="1000" value="36000">
              <input type="number" id="annualTaxNew" min="0" max="150000" step="1000" value="36000">
              <span class="st-unit">å††</span>
            </div></td>
            <td class="col-used"><div class="st-input">
              <input type="range" id="annualTaxUsedRange" min="0" max="150000" step="1000" value="36000">
              <input type="number" id="annualTaxUsed" min="0" max="150000" step="1000" value="36000">
              <span class="st-unit">å††</span>
            </div></td>
          </tr>
        </tbody>
      </table>
      <p class="settings-note">â€»2019å¹´ï¼ˆä»¤å’Œå…ƒå¹´ï¼‰10æœˆç™»éŒ²ã‚ˆã‚Šè‡ªå‹•è»Šç¨ã®ç¨é¡ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚å¹´å¼ã«å¿œã˜ã¦é‡‘é¡ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <div class="footer">
    â€»å…¥åŠ›ã•ã‚ŒãŸæ¡ä»¶ã«åŸºã¥ãæ¦‚ç®—ã§ã™ã€‚å®Ÿéš›ã®è²»ç”¨ã¯è»Šç¨®ãƒ»ä½¿ç”¨çŠ¶æ³ãƒ»åœ°åŸŸã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚<br>
    â€»ä¿è¨¼æœŸé–“ã¯æ–°è»Š5å¹´ã€ä¸­å¤è»Šï¼ˆèªå®šä¸­å¤è»Šï¼‰3å¹´ã¨ã—ã¦è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚ä¿è¨¼æœŸé–“ä¸­ã¯ä¸€èˆ¬æ•´å‚™è²»ç”¨ãŒã‹ã‹ã‚‰ãªã„æƒ³å®šã§ã™ã€‚<br>
    â€»ç‡ƒæ–™è²»ãƒ»ä¿é™ºæ–™ãƒ»é§è»Šå ´ä»£ãªã©ã€æ–°è»Šãƒ»ä¸­å¤è»Šã§å·®ãŒå‡ºã«ãã„è²»ç”¨ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// ===== ã‚°ãƒ©ãƒ•é…è‰² =====
const chartColors = {
  purchase:    '#c8bfb0',
  maintenance: '#5ba3bf',
  legal:       '#9b8ec4',
  tire:        '#5db88a',
  battery:     '#e2b84a',
  repair:      '#d47b4a',
  tax:         '#c08da0',
};

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function formatNumber(n) {
  return Math.round(n).toLocaleString('ja-JP');
}

function toWareki(year) {
  if (year >= 2019) return 'ä»¤å’Œ' + (year - 2018) + 'å¹´';
  if (year >= 1989) return 'å¹³æˆ' + (year - 1988) + 'å¹´';
  if (year >= 1926) return 'æ˜­å’Œ' + (year - 1925) + 'å¹´';
  return year + 'å¹´';
}

// ===== ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— =====
function getParams() {
  return {
    newCarPrice:      parseInt(document.getElementById('newCarPrice').value),
    usedCarPrice:     parseInt(document.getElementById('usedCarPrice').value),
    usedCarYear:      parseInt(document.getElementById('usedCarYear').value),
    totalOwnership:   parseInt(document.getElementById('totalOwnership').value),
    // ç¶­æŒè²»å˜ä¾¡ï¼ˆæ–°è»Šï¼‰
    shakenCostNew:       parseInt(document.getElementById('shakenCostNew').value),
    shakenLegalCostNew:  parseInt(document.getElementById('shakenLegalCostNew').value),
    inspectionCostNew:   parseInt(document.getElementById('inspectionCostNew').value),
    tireCostNew:         parseInt(document.getElementById('tireCostNew').value),
    batteryCostNew:      parseInt(document.getElementById('batteryCostNew').value),
    annualRepairCostNew: parseInt(document.getElementById('annualRepairCostNew').value),
    annualTaxNew:        parseInt(document.getElementById('annualTaxNew').value),
    // ç¶­æŒè²»å˜ä¾¡ï¼ˆä¸­å¤è»Šï¼‰
    shakenCostUsed:       parseInt(document.getElementById('shakenCostUsed').value),
    shakenLegalCostUsed:  parseInt(document.getElementById('shakenLegalCostUsed').value),
    inspectionCostUsed:   parseInt(document.getElementById('inspectionCostUsed').value),
    tireCostUsed:         parseInt(document.getElementById('tireCostUsed').value),
    batteryCostUsed:      parseInt(document.getElementById('batteryCostUsed').value),
    annualRepairCostUsed: parseInt(document.getElementById('annualRepairCostUsed').value),
    annualTaxUsed:        parseInt(document.getElementById('annualTaxUsed').value),
  };
}

// ===== è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ =====
function calculate(p) {
  const currentYear = new Date().getFullYear();

  const newCarOwnership = p.totalOwnership;
  const usedCarAge = currentYear - p.usedCarYear;
  const usedCarOwnership = p.totalOwnership - usedCarAge;

  const warning = usedCarOwnership <= 0;

  // å›æ•°
  const newShakenCount   = Math.max(0, Math.floor((newCarOwnership - 2.5) / 2));
  const usedShakenCount  = warning ? 0 : Math.max(0, Math.floor((usedCarOwnership - 1.5) / 2));
  const newTireCount     = Math.floor(newCarOwnership / 5);
  const usedTireCount    = warning ? 0 : Math.floor(usedCarOwnership / 5);
  const newBatteryCount  = Math.floor(newCarOwnership / 3);
  const usedBatteryCount = warning ? 0 : Math.floor(usedCarOwnership / 3);

  // æ–°è»Šã®è²»ç”¨ï¼ˆæ–°è»Šç”¨å˜ä¾¡ã‚’ä½¿ç”¨ï¼‰
  const newMaintenance = p.shakenCostNew * newShakenCount + p.inspectionCostNew * (newCarOwnership - newShakenCount);
  const newLegalCost   = p.shakenLegalCostNew * newShakenCount;
  const newTireCost    = p.tireCostNew * newTireCount;
  const newBatteryCost = p.batteryCostNew * newBatteryCount;
  const newWarrantyYears = 5;
  const newRepairCost  = Math.max(0, newCarOwnership - newWarrantyYears) * p.annualRepairCostNew;
  const newTaxTotal    = p.annualTaxNew * newCarOwnership;
  const newTotalCost   = p.newCarPrice + newMaintenance + newLegalCost + newTireCost + newBatteryCost + newRepairCost + newTaxTotal;

  // ä¸­å¤è»Šã®è²»ç”¨ï¼ˆä¸­å¤è»Šç”¨å˜ä¾¡ã‚’ä½¿ç”¨ï¼‰
  const usedMaintenance = warning ? 0 : p.shakenCostUsed * usedShakenCount + p.inspectionCostUsed * (usedCarOwnership - usedShakenCount);
  const usedLegalCost   = p.shakenLegalCostUsed * usedShakenCount;
  const usedTireCost    = p.tireCostUsed * usedTireCount;
  const usedBatteryCost = p.batteryCostUsed * usedBatteryCount;
  const usedWarrantyYears = 3;
  const usedRepairCost  = warning ? 0 : Math.max(0, usedCarOwnership - usedWarrantyYears) * p.annualRepairCostUsed;
  const usedTaxTotal    = warning ? 0 : p.annualTaxUsed * usedCarOwnership;
  const usedTotalCost   = p.usedCarPrice + usedMaintenance + usedLegalCost + usedTireCost + usedBatteryCost + usedRepairCost + usedTaxTotal;

  // å¹´æ›ç®—ã‚³ã‚¹ãƒˆ
  const newAnnualCost  = newTotalCost / newCarOwnership;
  const usedAnnualCost = warning ? 0 : usedTotalCost / usedCarOwnership;
  const annualDifference = warning ? 0 : newAnnualCost - usedAnnualCost;

  return {
    currentYear, usedCarAge, newCarOwnership, usedCarOwnership, warning,
    newShakenCount, usedShakenCount, newTireCount, usedTireCount,
    newBatteryCount, usedBatteryCount,
    newMaintenance, usedMaintenance, newLegalCost, usedLegalCost,
    newTireCost, usedTireCost, newBatteryCost, usedBatteryCost,
    newRepairCost, usedRepairCost, newTaxTotal, usedTaxTotal,
    newTotalCost, usedTotalCost, newAnnualCost, usedAnnualCost,
    annualDifference,
    newWarrantyYears, usedWarrantyYears,
    newCarPrice: p.newCarPrice, usedCarPrice: p.usedCarPrice,
    totalOwnership: p.totalOwnership, usedCarYear: p.usedCarYear,
  };
}

// ===== KPIæ›´æ–° =====
function updateKPI(r) {
  document.getElementById('kpiNewAnnual').innerHTML =
    formatNumber(r.newAnnualCost) + '<span class="kpi-unit">å††/å¹´</span>';

  if (r.warning) {
    document.getElementById('kpiUsedAnnual').innerHTML = '-<span class="kpi-unit">å††/å¹´</span>';
    document.getElementById('kpiDiffValue').innerHTML = '-<span class="kpi-unit">å††/å¹´</span>';
    document.getElementById('kpiVerdict').textContent = '-';
    document.getElementById('kpiDiffCard').style.borderLeftColor = 'var(--border-color)';
    document.getElementById('kpiDiffCard').style.background = 'var(--bg-card)';
  } else {
    document.getElementById('kpiUsedAnnual').innerHTML =
      formatNumber(r.usedAnnualCost) + '<span class="kpi-unit">å††/å¹´</span>';

    const diff = Math.abs(r.annualDifference);
    const diffCard = document.getElementById('kpiDiffCard');
    const newCheaper = r.annualDifference < 0;

    document.getElementById('kpiDiffValue').innerHTML =
      formatNumber(diff) + '<span class="kpi-unit">å††/å¹´</span>';

    if (r.annualDifference === 0) {
      document.getElementById('kpiVerdict').textContent = 'åŒé¡';
      diffCard.style.borderLeftColor = 'var(--result-positive)';
      diffCard.style.background = 'var(--result-positive-light)';
      document.getElementById('kpiDiffValue').style.color = 'var(--result-positive)';
      document.getElementById('kpiVerdict').style.color = 'var(--result-positive)';
    } else if (newCheaper) {
      document.getElementById('kpiVerdict').textContent = 'æ–°è»ŠãŒå¹´é–“ã‚³ã‚¹ãƒˆãŒå®‰ã„';
      diffCard.style.borderLeftColor = 'var(--new-car-color)';
      diffCard.style.background = 'var(--new-car-light)';
      document.getElementById('kpiDiffValue').style.color = 'var(--new-car-color)';
      document.getElementById('kpiVerdict').style.color = 'var(--new-car-color)';
    } else {
      document.getElementById('kpiVerdict').textContent = 'ä¸­å¤è»ŠãŒå¹´é–“ã‚³ã‚¹ãƒˆãŒå®‰ã„';
      diffCard.style.borderLeftColor = 'var(--used-car-color)';
      diffCard.style.background = 'var(--used-car-light)';
      document.getElementById('kpiDiffValue').style.color = 'var(--used-car-color)';
      document.getElementById('kpiVerdict').style.color = 'var(--used-car-color)';
    }
  }

  // ã‚µãƒãƒªãƒ¼
  document.getElementById('summaryNew').textContent = 'ç·é¡ ' + formatNumber(r.newTotalCost) + 'å††';
  document.getElementById('summaryNewYears').textContent = r.newCarOwnership;
  if (r.warning) {
    document.getElementById('summaryUsed').textContent = 'ç·é¡ -å††';
    document.getElementById('summaryUsedYears').textContent = '-';
  } else {
    document.getElementById('summaryUsed').textContent = 'ç·é¡ ' + formatNumber(r.usedTotalCost) + 'å††';
    document.getElementById('summaryUsedYears').textContent = r.usedCarOwnership;
  }

  // è‡ªå‹•è¨ˆç®—è¡¨ç¤º
  document.getElementById('usedCarAge').textContent = r.usedCarAge;
  const ownershipEl = document.getElementById('usedCarOwnership');
  const remainingInfo = document.getElementById('remainingInfo');
  if (r.warning) {
    ownershipEl.textContent = r.usedCarOwnership;
    remainingInfo.classList.add('warning');
  } else {
    ownershipEl.textContent = r.usedCarOwnership;
    remainingInfo.classList.remove('warning');
  }

  // è­¦å‘Š
  const warningEl = document.getElementById('warningMessage');
  if (r.warning) {
    warningEl.classList.add('show');
  } else {
    warningEl.classList.remove('show');
  }

  // å’Œæš¦è¡¨ç¤ºæ›´æ–°
  document.getElementById('warekiDisplay').textContent = 'ï¼ˆ' + toWareki(r.usedCarYear) + 'ï¼‰';

  // å°åˆ·ç”¨æ¡ä»¶ã‚µãƒãƒªãƒ¼æ›´æ–°
  document.getElementById('pcNewPrice').textContent = formatNumber(r.newCarPrice) + 'å††';
  document.getElementById('pcUsedPrice').textContent = formatNumber(r.usedCarPrice) + 'å††';
  document.getElementById('pcUsedYear').textContent = r.usedCarYear + 'å¹´ï¼' + toWareki(r.usedCarYear);
  document.getElementById('pcAge').textContent = r.usedCarAge;
  document.getElementById('pcOwnership').textContent = r.totalOwnership;
  document.getElementById('pcRemaining').textContent = r.warning ? '-' : r.usedCarOwnership;
}

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–° =====
function updateTable(r) {
  const tbody = document.getElementById('costTableBody');
  const rows = [];

  function row(label, newVal, usedVal, desc, cls) {
    const nv = r.warning && label !== 'è³¼å…¥é‡‘é¡' ? '-' : formatNumber(newVal);
    const uv = r.warning ? '-' : formatNumber(usedVal);
    return `<tr class="${cls || ''}">
      <td>${label}</td><td>${nv}å††</td><td>${uv}å††</td><td>${desc}</td>
    </tr>`;
  }

  rows.push(row('è³¼å…¥é‡‘é¡', r.newCarPrice, r.usedCarPrice, ''));
  rows.push(row('å®šæœŸæ•´å‚™ä»£', r.newMaintenance, r.usedMaintenance,
    `è»Šæ¤œ${r.newShakenCount}å›+ç‚¹æ¤œ${r.newCarOwnership - r.newShakenCount}å› / è»Šæ¤œ${r.usedShakenCount}å›+ç‚¹æ¤œ${r.warning ? '-' : r.usedCarOwnership - r.usedShakenCount}å›`));
  rows.push(row('æ³•å®šè²»ç”¨', r.newLegalCost, r.usedLegalCost,
    `è»Šæ¤œ${r.newShakenCount}å›åˆ† / ${r.usedShakenCount}å›åˆ†`));
  rows.push(row('ã‚¿ã‚¤ãƒ¤äº¤æ›', r.newTireCost, r.usedTireCost,
    `${r.newTireCount}å›åˆ† / ${r.usedTireCount}å›åˆ†`));
  rows.push(row('ãƒãƒƒãƒ†ãƒªãƒ¼äº¤æ›', r.newBatteryCost, r.usedBatteryCost,
    `${r.newBatteryCount}å›åˆ† / ${r.usedBatteryCount}å›åˆ†`));
  rows.push(row('ä¸€èˆ¬æ•´å‚™è²»ç”¨', r.newRepairCost, r.usedRepairCost,
    `ä¿è¨¼${r.newWarrantyYears}å¹´é™¤ã${Math.max(0, r.newCarOwnership - r.newWarrantyYears)}å¹´åˆ† / ä¿è¨¼${r.usedWarrantyYears}å¹´é™¤ã${r.warning ? '-' : Math.max(0, r.usedCarOwnership - r.usedWarrantyYears)}å¹´åˆ†`));
  rows.push(row('è‡ªå‹•è»Šç¨', r.newTaxTotal, r.usedTaxTotal,
    `${r.newCarOwnership}å¹´åˆ† / ${r.warning ? '-' : r.usedCarOwnership}å¹´åˆ†`));

  rows.push(`<tr class="total-row">
    <td>ç¶­æŒè²»ç·é¡</td>
    <td>${formatNumber(r.newTotalCost)}å††</td>
    <td>${r.warning ? '-å††' : formatNumber(r.usedTotalCost) + 'å††'}</td>
    <td></td>
  </tr>`);

  rows.push(`<tr>
    <td>æ‰€æœ‰å¹´æ•°</td>
    <td>${r.newCarOwnership}å¹´</td>
    <td>${r.warning ? '-å¹´' : r.usedCarOwnership + 'å¹´'}</td>
    <td></td>
  </tr>`);

  const newCheaper = !r.warning && r.annualDifference < 0;
  const usedCheaper = !r.warning && r.annualDifference > 0;
  rows.push(`<tr class="annual-row">
    <td>å¹´é–“ã‚³ã‚¹ãƒˆ</td>
    <td class="${newCheaper ? 'highlight-new' : ''}">${formatNumber(r.newAnnualCost)}å††</td>
    <td class="${usedCheaper ? 'highlight-used' : ''}">${r.warning ? '-å††' : formatNumber(r.usedAnnualCost) + 'å††'}</td>
    <td></td>
  </tr>`);

  tbody.innerHTML = rows.join('');
}

// ===== Chart.js =====
let annualChart = null;

function initCharts() {
  const ctx = document.getElementById('annualChart').getContext('2d');
  annualChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['æ–°è»Š', 'ä¸­å¤è»Š'],
      datasets: [
        { label: 'è³¼å…¥é‡‘é¡',       data: [0, 0], backgroundColor: chartColors.purchase },
        { label: 'å®šæœŸæ•´å‚™ä»£',     data: [0, 0], backgroundColor: chartColors.maintenance },
        { label: 'æ³•å®šè²»ç”¨',       data: [0, 0], backgroundColor: chartColors.legal },
        { label: 'ã‚¿ã‚¤ãƒ¤äº¤æ›',     data: [0, 0], backgroundColor: chartColors.tire },
        { label: 'ãƒãƒƒãƒ†ãƒªãƒ¼äº¤æ›', data: [0, 0], backgroundColor: chartColors.battery },
        { label: 'ä¸€èˆ¬æ•´å‚™',       data: [0, 0], backgroundColor: chartColors.repair },
        { label: 'è‡ªå‹•è»Šç¨',       data: [0, 0], backgroundColor: chartColors.tax },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: false,
      layout: { padding: { top: 30, right: 20 } },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11, family: "'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif" } } },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + formatNumber(Math.round(ctx.raw)) + 'å††/å¹´';
            },
            footer: function(items) {
              var total = 0;
              items.forEach(function(item) { total += item.raw; });
              return 'åˆè¨ˆ: ' + formatNumber(Math.round(total)) + 'å††/å¹´';
            }
          }
        },
      },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: { callback: function(v) { return (v / 10000).toLocaleString() + 'ä¸‡'; } },
        },
      },
    },
    plugins: [{
      id: 'stackedTotalLabel',
      afterDatasetsDraw: function(chart) {
        var ctx2 = chart.ctx;
        var lastMeta = chart.getDatasetMeta(chart.data.datasets.length - 1);
        ctx2.save();
        ctx2.font = "bold 14px 'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif";
        ctx2.textAlign = 'center';
        lastMeta.data.forEach(function(bar, i) {
          var total = 0;
          chart.data.datasets.forEach(function(ds) { total += ds.data[i]; });
          if (total === 0) return;
          ctx2.fillStyle = i === 0 ? '#1a6b8a' : '#b35c1e';
          ctx2.fillText(formatNumber(Math.round(total)) + 'å††/å¹´', bar.x, bar.y - 10);
        });
        ctx2.restore();
      }
    }],
  });
}

function updateChart(r) {
  var nY = r.newCarOwnership;
  var uY = r.warning ? 1 : r.usedCarOwnership;
  var w = r.warning;
  annualChart.data.datasets[0].data = [r.newCarPrice / nY, w ? 0 : r.usedCarPrice / uY];
  annualChart.data.datasets[1].data = [r.newMaintenance / nY, w ? 0 : r.usedMaintenance / uY];
  annualChart.data.datasets[2].data = [r.newLegalCost / nY, w ? 0 : r.usedLegalCost / uY];
  annualChart.data.datasets[3].data = [r.newTireCost / nY, w ? 0 : r.usedTireCost / uY];
  annualChart.data.datasets[4].data = [r.newBatteryCost / nY, w ? 0 : r.usedBatteryCost / uY];
  annualChart.data.datasets[5].data = [r.newRepairCost / nY, w ? 0 : r.usedRepairCost / uY];
  annualChart.data.datasets[6].data = [r.newTaxTotal / nY, w ? 0 : r.usedTaxTotal / uY];
  annualChart.update();
}

// ===== æŠ˜ã‚ŠãŸãŸã¿ =====
function toggleSettings() {
  const btn = document.getElementById('settingsToggle');
  const content = document.getElementById('settingsContent');
  btn.classList.toggle('open');
  content.classList.toggle('open');
}

// ===== åŒæ–¹å‘åŒæœŸ =====
function syncInputs() {
  const pairs = [
    // ã‚°ãƒ«ãƒ¼ãƒ—1
    ['newCarPriceRange', 'newCarPrice'],
    ['usedCarPriceRange', 'usedCarPrice'],
    ['usedCarYearRange', 'usedCarYear'],
    ['totalOwnershipRange', 'totalOwnership'],
    // ã‚°ãƒ«ãƒ¼ãƒ—2: æ–°è»Š
    ['shakenCostNewRange', 'shakenCostNew'],
    ['shakenLegalCostNewRange', 'shakenLegalCostNew'],
    ['inspectionCostNewRange', 'inspectionCostNew'],
    ['tireCostNewRange', 'tireCostNew'],
    ['batteryCostNewRange', 'batteryCostNew'],
    ['annualRepairCostNewRange', 'annualRepairCostNew'],
    ['annualTaxNewRange', 'annualTaxNew'],
    // ã‚°ãƒ«ãƒ¼ãƒ—2: ä¸­å¤è»Š
    ['shakenCostUsedRange', 'shakenCostUsed'],
    ['shakenLegalCostUsedRange', 'shakenLegalCostUsed'],
    ['inspectionCostUsedRange', 'inspectionCostUsed'],
    ['tireCostUsedRange', 'tireCostUsed'],
    ['batteryCostUsedRange', 'batteryCostUsed'],
    ['annualRepairCostUsedRange', 'annualRepairCostUsed'],
    ['annualTaxUsedRange', 'annualTaxUsed'],
  ];

  pairs.forEach(([rangeId, numberId]) => {
    const range = document.getElementById(rangeId);
    const number = document.getElementById(numberId);

    range.addEventListener('input', function() {
      number.value = this.value;
      recalculate();
    });
    number.addEventListener('input', function() {
      range.value = this.value;
      recalculate();
    });
  });
}

// ===== å¹´å¼ã®ä¸Šé™ã‚’å½“å¹´ã«å‹•çš„è¨­å®š =====
function setYearLimits() {
  const currentYear = new Date().getFullYear();
  document.getElementById('usedCarYearRange').max = currentYear;
  document.getElementById('usedCarYear').max = currentYear;
}

// ===== å…¨ä½“å†è¨ˆç®— =====
function recalculate() {
  const params = getParams();
  const result = calculate(params);
  updateKPI(result);
  updateChart(result);
  updateTable(result);
}

// ===== åˆæœŸåŒ– =====
window.addEventListener('DOMContentLoaded', function() {
  setYearLimits();
  initCharts();
  syncInputs();
  recalculate();
});
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
